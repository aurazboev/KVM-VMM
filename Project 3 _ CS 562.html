<!DOCTYPE html>
<!-- saved from url=(0065)https://khale.github.io/iit-cs562-s24-site/projects/04-micro-vmm/ -->
<html lang="en-US" data-theme="light"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="https://khale.github.io/iit-cs562-s24-site/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="./Project 3 _ CS 562_files/just-the-docs-default.css"> <script type="text/javascript" src="./Project 3 _ CS 562_files/lunr.min.js"></script> <script type="text/javascript" src="./Project 3 _ CS 562_files/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Project 3 | CS 562</title><meta name="generator" content="Jekyll v3.9.5"><meta property="og:title" content="Project 3"><meta name="author" content="Kyle Hale"><meta property="og:locale" content="en_US"><meta name="description" content="Into the Depths of Virtualization and Virtual Machines"><meta property="og:description" content="Into the Depths of Virtualization and Virtual Machines"><link rel="canonical" href="https://khale.github.io/iit-cs562-s24-site/projects/04-micro-vmm/"><meta property="og:url" content="https://khale.github.io/iit-cs562-s24-site/projects/04-micro-vmm/"><meta property="og:site_name" content="CS 562"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta property="twitter:title" content="Project 3"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Kyle Hale"},"description":"Into the Depths of Virtualization and Virtual Machines","headline":"Project 3","url":"https://khale.github.io/iit-cs562-s24-site/projects/04-micro-vmm/"}</script><style type="text/css">iframe#teal-job-tracker-iframe-stable {
    min-width: 380px !important;
    width: 380px !important;
    min-height: 100vh !important;
    height: 100vh !important;
  }

  @media print {
    #teal-job-tracker-root-stable, #teal-job-tracker-companion-root-stable {
      display: none !important;
    }
  }</style></head><body data-new-gr-c-s-check-loaded="14.1190.0" data-gr-ext-installed=""> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <script type="text/javascript" src="./Project 3 _ CS 562_files/toggle_init.js"></script><div class="side-bar"><div class="site-header"> <a href="https://khale.github.io/iit-cs562-s24-site/" class="site-title lh-tight"> CS 562 </a> <a href="https://khale.github.io/iit-cs562-s24-site/projects/04-micro-vmm/#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/calendar/" class="nav-list-link">Course Calendar</a></li><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/assets/notes/emu/" class="nav-list-link">Emulation</a></li><li class="nav-list-item active"><a href="https://khale.github.io/iit-cs562-s24-site/projects/04-micro-vmm/#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://khale.github.io/iit-cs562-s24-site/projects/" class="nav-list-link active">Projects</a><ul class="nav-list"><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/projects/01-6502-prelim/" class="nav-list-link">Project 1 Prelim</a></li><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/projects/02-6502/" class="nav-list-link">Project 1</a></li><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/projects/03-hawkbeans/" class="nav-list-link">Project 2</a></li><li class="nav-list-item active"><a href="https://khale.github.io/iit-cs562-s24-site/projects/04-micro-vmm/" class="nav-list-link active">Project 3</a></li><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/projects/05-hawker/" class="nav-list-link">Project 4</a></li><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/projects/06-research/" class="nav-list-link">Project X</a></li></ul></li><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/schedule/" class="nav-list-link">Schedule</a></li><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/staff/" class="nav-list-link">Staff</a></li><li class="nav-list-item"><a href="https://khale.github.io/iit-cs562-s24-site/about/" class="nav-list-link">Syllabus</a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search CS 562" aria-label="Search CS 562" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://halek.co/" class="site-button"> Kyle C. Hale </a></li></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"> <a href="https://khale.github.io/iit-cs562-s24-site/projects/">Projects</a></li><li class="breadcrumb-nav-list-item"> <span>Project 3</span></li></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="project-3-micro-vmm">Project 3: Micro VMM</h1><p>Released: Monday, 03/18/2024 <strong>Due Date: Friday, 4/05/2024 11:59PM CST</strong></p><h2 id="overview">Overview</h2><p>For this project, you will build a small hypervisor using the <a href="https://www.kernel.org/doc/Documentation/virtual/kvm/api.txt">KVM API</a>. I’m not going to give you much direction here, just a simple specification. You can build the hypervisor using whatever language you like, but you’ll want something that has bindings to KVM, e.g., C, C++, Rust, possibly Go, or something which would make it easy to add such bindings. You’ll want to start by going through the <a href="https://lwn.net/Articles/658511/">LWN tutorial</a> on getting started with KVM. If you’re going to work on a VM, you’ll want to make sure you have KVM installed (including the development headers) and you’ll want to make sure that nested virtualization is enabled in your VM manager. For example, VMware calls this option “enable hypervisor applications.”</p><h2 id="vmm-requirements">VMM Requirements</h2><ul><li>Your VMM will be designed for x86-64, and will run on Linux using KVM</li><li>Your VMM must take a binary file as a command-line argument. This binary file will encapsulate some code (for a VM). This code will be relatively simple for you, but could eventually evolve into an OS kernel. Your VMM must be able to load this binary into guest memory and run it. To get started it will be easier to use a raw binary, but if you make significant progress, you may want to take a look at libelf to be able to parse and load ELF binaries. This would be a necessary step to getting an OS running.</li><li>Your VMM should include a very simple line-buffered console device. It will have a very basic interface to the guest. If the guest writes a printable byte to IO port 0x42, that byte will be saved in a buffer. If a newline character is written, the buffer will be printed to the screen and the buffer will be flushed.</li><li>Your VMM must include a virtual keyboard device. This does not have to be a full keyboard device, just a few keys are fine. Your VMM will accept input one byte at a time from STDIN and set an 8-bit register (IO port 0x44) to a value corresponding to the key pressed. It will notify the guest that there was a keypress by setting a status register (IO port 0x45) to 1. When the guest detects that a key has been pressed, it must ack the event by clearing the status register.</li><li>Your VMM will include a virtual interval timer. The guest will write a time value (call it N) in milliseconds to IO port 0x46 and will enable the timer by writing a 1 to bit 0 of IO port 0x47. The timer is disabled by clearing the same bit. While the timer is enabled, it will periodically notify the guest on timer events by setting bit 1 on IO port 0x47. The guest must again ack and clear this “timer fired” bit when it notices the event. If the guest has not ack’d a previous timer event when a new one is fired, the event is lost. You may want to look at the GC timing code in Hawkbeans for inspiration here. You can also take a look at the Linux timer subsystem (e.g., <code class="language-plaintext highlighter-rouge">timer_create()</code>).</li><li>Your guest will initially be a simple binary, but you will have to extend it to include a console and keyboard driver. The keyboard and console drivers will operate according to the hardware spec above.</li><li>You’ll probably have noticed at this point that we haven’t involved interrupts. To make our VMM and guest simpler, we’re going to use polled I/O. This means that instead of receiving interrupts, the guest will poll on device registers to check for events. Your guest must thus enter an event loop, checking every device’s status register (keyboard and timer) to see if an event must be handled. This will save you the pain of dealing with KVM’s IRQCHIP logic and interrupt routing, and setting up an IDT and interrupt handlers in your guest.</li><li>Once you’ve got this all in place, your guest will accept some input from the keyboard, and when the user hits enter, the guest will then echo that line to the console on every timer event, until a new line is entered.</li></ul><h2 id="tips">Tips</h2><p>You probably are not going to want to hand assemble code for your guest (as in the KVM example linked above). Here is a <code class="language-plaintext highlighter-rouge">gcc</code> invocation that might help:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>as <span class="nt">--32</span> <span class="nt">-o</span> smallkern.o smallkern.S
ld <span class="nt">-m</span> elf_i386 <span class="nt">-Ttext</span> 0x7c00 <span class="nt">--oformat</span> binary <span class="nt">-o</span> smallkern smallkern.o
</code></pre></div></div><p>This will compile and link your x86 assembly into a flat binary (not ELF). This assumes that the code will be loaded at address 0x7c00, but you will obviously want to change this. It’s not hard to extend this to work with C code, but you’ll want to use the compiler flags <code class="language-plaintext highlighter-rouge">-ffreestanding</code>, <code class="language-plaintext highlighter-rouge">-nostdlib</code>, and <code class="language-plaintext highlighter-rouge">-m32</code>.</p><h2 id="next-steps">Next Steps</h2><p>If you’ve gotten this far and you’re looking to make your VMM/guest more interesting, here are some tips:</p><ul><li>Figure out how to set up interrupts in KVM (see KVM’s IRQCHIP calls, and irqfd functionality)</li><li>Implement a virtual VGA device, e.g., a simple framebuffer console. See <a href="https://wiki.osdev.org/Text_UI">here</a>.</li><li>Enhance your guest by allowing it to boot into protected and then long (64-bit) mode. You’ll have to deal with setting up paging and setting up the GDT to achieve this. You can also set up the IDT and implement interrupt handlers. At this point you’ll have a little OS kernel of your own.</li><li>Implement virtio for your guest (paravirtualized network, disk, etc.) and VMM. This will allow your guest to use networking/storage without using drivers that are very complicated.</li><li>Take a look at Amazon’s <a href="https://github.com/firecracker-microvm/firecracker">Firecracker</a> or if you’re ambitious QEMU for more ideas.</li></ul><h2 id="hand-in">Hand-in</h2><p>You will hand in your code to me by sending me your code in tarball form (email is fine). You must include a <code class="language-plaintext highlighter-rouge">Makefile</code> to build your VMM/guest and a <code class="language-plaintext highlighter-rouge">README</code> which describes how to build and run a VM in your hypervisor. Ideally include scripts to do this (e.g., <code class="language-plaintext highlighter-rouge">make run</code>).</p><hr><footer><p class="text-small text-grey-dk-100 mb-0">Kyle C. Hale © 2024 <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></p></footer></div></div><div class="search-overlay"></div></div><script type="text/javascript" src="./Project 3 _ CS 562_files/toggle_mode.js"></script>
<div id="teal-job-tracker-root-stable" style="z-index: 2147483647;"><iframe id="teal-job-tracker-iframe-stable" style="background: rgb(255, 255, 255) !important; width: 380px !important; height: 100vh !important; position: fixed !important; inset: 0px -380px auto auto !important; z-index: 2147483647 !important; border: 0px !important; box-shadow: rgba(0, 0, 0, 0.25) 0px 0px 16px -3px !important; transition: right 0.25s ease-in-out !important; transform: none !important;" src="./Project 3 _ CS 562_files/saved_resource.html"></iframe></div><div id="teal-job-tracker-companion-root-stable" style="display: block; z-index: 2147483646; bottom: 58px; right: 0px; position: fixed; height: 60px; width: auto;"></div></body><grammarly-desktop-integration data-grammarly-shadow-root="true"><template shadowrootmode="open"><style>
      div.grammarly-desktop-integration {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select:none;
        user-select:none;
      }

      div.grammarly-desktop-integration:before {
        content: attr(data-content);
      }
    </style><div aria-label="grammarly-integration" role="group" tabindex="-1" class="grammarly-desktop-integration" data-content="{&quot;mode&quot;:&quot;full&quot;,&quot;isActive&quot;:true,&quot;isUserDisabled&quot;:false}"></div></template></grammarly-desktop-integration></html>